== Refactoring -> Spring to Spring Boot

=== Create Spring Starter project using eclipse

=== Move class to other base package now : pl.java.scalatech with safe this same layer naming

=== Refactoring naming package

=== Spring jdbc dependecy needed

----
<dependency>
        <groupId>org.springframework.boot</groupId>
         <artifactId>spring-boot-starter-jdbc</artifactId>  
       </dependency>
----

----
import org.springframework.jdbc.core.simple.ParameterizedBeanPropertyRowMapper;

BeanPropertyRowMapper.newInstance

instead of


ParameterizedBeanPropertyRowMapper.newInstance(Owner.class)

----

----
RowMapper

instead of

ParameterizedRowMapper 
----


=== Joda -> java 8 data-time

----
LocalDateTime
----

** JDBC

----
Date in = new Date();
LocalDateTime ldt = LocalDateTime.ofInstant(in.toInstant(), ZoneId.systemDefault());
Date out = Date.from(ldt.atZone(ZoneId.systemDefault()).toInstant());

----

** Remove jadira from entities


=== VetsAtomView extends AbstractAtomFeedView  => atom dependency needed

----
<dependency>
          <groupId>com.rometools</groupId>
          <artifactId>rome</artifactId>
          <version>1.5.0</version>
        </dependency>
----

=== Clearing constructor - > remove @Autowired


=== Use profile jdbc,data,jpa


=== application.properties set active profile on data

=== Config web

** Mapping

----
  @Bean
    public MessageSource messageSource() {
        ReloadableResourceBundleMessageSource messageSource = new ReloadableResourceBundleMessageSource();
        messageSource.setBasename("classpath:/messages");
        messageSource.setUseCodeAsDefaultMessage(true);
        messageSource.setCacheSeconds(20);
        return messageSource;
    }
----

** View

----
 registry.addViewController("/").setViewName("welcome");
----


** SimpleError

----
  @Bean
    SimpleMappingExceptionResolver exceptionResolver(){
        SimpleMappingExceptionResolver resolver = new SimpleMappingExceptionResolver();
        resolver.setDefaultErrorView("exception");
        resolver.setWarnLogCategory("warn");
        return resolver;
        
    }
----

** Static resources

----
 @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {  // mapujemy statyczne zasoby        
        registry.addResourceHandler("/webjars/**").addResourceLocations("classpath:/META-INF/resources/webjars/").setCachePeriod(3000);
        registry.addResourceHandler("/resources/**").addResourceLocations("/resources");
        registry.addResourceHandler("/css/**").addResourceLocations("classpath:/static/css/").setCachePeriod(0);
        registry.addResourceHandler("/images/**").addResourceLocations("classpath:/resources/images/").setCachePeriod(3000);        
        registry.addResourceHandler("/static/**").addResourceLocations("classpath:/static/");
        registry.addResourceHandler("/js/**").addResourceLocations("classpath:/js/").setCachePeriod(3000);
        
    }
----

*** Next problem mapping for css for past thymeleaf setting

----
  registry.addResourceHandler("/internal/**").addResourceLocations("classpath:/");
  registry.addResourceHandler("/webjars/**").addResourceLocations("classpath:/META-INF/resources/webjars/").setCachePeriod(3000);
  registry.addResourceHandler("/resources/**").addResourceLocations("classpath:/");
----



** Listeners

----
 registry.addInterceptor(localeChangeInterceptor);
----

** Formatters

----
 @Override
    public void addFormatters(FormatterRegistry registry) {
        super.addFormatters(registry);
        registry.addFormatter(new PetTypeFormatter(clinicService));
        
    }
----




===  Error creating bean with name 'defaultServletHandlerMapping'  problem

----
@EnableWebMvc
----


=== Add lombok & guava

=== Add logback.xml to resources


=== Add static dependency

----

     <webjars-bootstrap.version>2.3.0</webjars-bootstrap.version>
        <webjars-jquery-ui.version>1.9.2</webjars-jquery-ui.version>
        <webjars-jquery.version>1.9.0</webjars-jquery.version>
        <dandelion.datatables.version>0.8.7</dandelion.datatables.version>

<dependency>
            <groupId>org.webjars</groupId>
            <artifactId>bootstrap</artifactId>
            <version>${webjars-bootstrap.version}</version>
        </dependency>
        <dependency>
            <groupId>org.webjars</groupId>
            <artifactId>jquery-ui</artifactId>
            <version>${webjars-jquery-ui.version}</version>
        </dependency>
        <dependency>
            <groupId>org.webjars</groupId>
            <artifactId>jquery</artifactId>
            <version>${webjars-jquery.version}</version>
        </dependency>
----

=== Error

----
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'defaultServletHandlerMapping' defined in class path resource [pl/java/scalatech/config/WebConfig.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.springframework.web.servlet.HandlerMapping]: Factory method 'defaultServletHandlerMapping' threw exception; nested exception is java.lang.IllegalArgumentException: A ServletContext is required to configure default servlet handling
    at org.springframework.beans.factory.support.ConstructorResolver.instantiateUsingFactoryMethod(ConstructorResolver.java:599)
    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.instantiateUsingFactoryMethod(AbstractAutowireCapableBeanFactory.java:1123)
    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance(AbstractAutowireCapableBeanFactory.java:1018)
    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:510)
    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:482)
    at org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:306)
    at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:230)
    at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:302)
    at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:197)
    at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:776)
    at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:861)
    at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:541)
    at org.springframework.boot.context.embedded.EmbeddedWebApplicationContext.refresh(EmbeddedWebApplicationContext.java:122)
    at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:759)
    at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:369)
    at org.springframework.boot.SpringApplication.run(SpringApplication.java:313)
    at org.springframework.boot.SpringApplication.run(SpringApplication.java:1185)
    at org.springframework.boot.SpringApplication.run(SpringApplication.java:1174)
    at pl.java.scalatech.Petclinic2Application.main(Petclinic2Application.java:14)
    ... 6 more
Caused by: org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.springframework.web.servlet.HandlerMapping]: Factory method 'defaultServletHandlerMapping' threw exception; nested exception is java.lang.IllegalArgumentException: A ServletContext is required to configure default servlet handling
    at org.springframework.beans.factory.support.SimpleInstantiationStrategy.instantiate(SimpleInstantiationStrategy.java:189)
    at org.springframework.beans.factory.support.ConstructorResolver.instantiateUsingFactoryMethod(ConstructorResolver.java:588)
    ... 24 more
Caused by: java.lang.IllegalArgumentException: A ServletContext is required to configure default servlet handling
    at org.springframework.util.Assert.notNull(Assert.java:115)
    at org.springframework.web.servlet.config.annotation.DefaultServletHandlerConfigurer.<init>(DefaultServletHandlerConfigurer.java:53)
    at org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport.defaultServletHandlerMapping(WebMvcConfigurationSupport.java:456)
    at pl.java.scalatech.config.WebConfig$$EnhancerBySpringCGLIB$$7c57ff5b.CGLIB$defaultServletHandlerMapping$32(<generated>)
    at pl.java.scalatech.config.WebConfig$$EnhancerBySpringCGLIB$$7c57ff5b$$FastClassBySpringCGLIB$$4e16a01e.invoke(<generated>)
    at org.springframework.cglib.proxy.MethodProxy.invokeSuper(MethodProxy.java:228)
    at org.springframework.context.annotation.ConfigurationClassEnhancer$BeanMethodInterceptor.intercept(ConfigurationClassEnhancer.java:356)
    at pl.java.scalatech.config.WebConfig$$EnhancerBySpringCGLIB$$7c57ff5b.defaultServletHandlerMapping(<generated>)
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:498)
    at org.springframework.beans.factory.support.SimpleInstantiationStrategy.instantiate(SimpleInstantiationStrategy.java:162)

----

**Separate MessageSource messageSource()  from  WebConfig extends  WebMvcConfigurationSupport solved problem !!**

=== Populate data

----
schema.sql
data.sql

----

----
INSERT INTO vets VALUES (1, 'James', 'Carter');
INSERT INTO vets VALUES (2, 'Helen', 'Leary');
INSERT INTO vets VALUES (3, 'Linda', 'Douglas');
INSERT INTO vets VALUES (4, 'Rafael', 'Ortega');
INSERT INTO vets VALUES (5, 'Henry', 'Stevens');
INSERT INTO vets VALUES (6, 'Sharon', 'Jenkins');

INSERT INTO specialties VALUES (1, 'radiology');
INSERT INTO specialties VALUES (2, 'surgery');
INSERT INTO specialties VALUES (3, 'dentistry');

INSERT INTO vet_specialties VALUES (2, 1);
INSERT INTO vet_specialties VALUES (3, 2);
INSERT INTO vet_specialties VALUES (3, 3);
INSERT INTO vet_specialties VALUES (4, 2);
INSERT INTO vet_specialties VALUES (5, 1);

INSERT INTO types VALUES (1, 'cat');
INSERT INTO types VALUES (2, 'dog');
INSERT INTO types VALUES (3, 'lizard');
INSERT INTO types VALUES (4, 'snake');
INSERT INTO types VALUES (5, 'bird');
INSERT INTO types VALUES (6, 'hamster');

INSERT INTO owners VALUES (1, 'George', 'Franklin', '110 W. Liberty St.', 'Madison', '6085551023');
INSERT INTO owners VALUES (2, 'Betty', 'Davis', '638 Cardinal Ave.', 'Sun Prairie', '6085551749');
INSERT INTO owners VALUES (3, 'Eduardo', 'Rodriquez', '2693 Commerce St.', 'McFarland', '6085558763');
INSERT INTO owners VALUES (4, 'Harold', 'Davis', '563 Friendly St.', 'Windsor', '6085553198');
INSERT INTO owners VALUES (5, 'Peter', 'McTavish', '2387 S. Fair Way', 'Madison', '6085552765');
INSERT INTO owners VALUES (6, 'Jean', 'Coleman', '105 N. Lake St.', 'Monona', '6085552654');
INSERT INTO owners VALUES (7, 'Jeff', 'Black', '1450 Oak Blvd.', 'Monona', '6085555387');
INSERT INTO owners VALUES (8, 'Maria', 'Escobito', '345 Maple St.', 'Madison', '6085557683');
INSERT INTO owners VALUES (9, 'David', 'Schroeder', '2749 Blackhawk Trail', 'Madison', '6085559435');
INSERT INTO owners VALUES (10, 'Carlos', 'Estaban', '2335 Independence La.', 'Waunakee', '6085555487');

INSERT INTO pets VALUES (1, 'Leo', '2010-09-07', 1, 1);
INSERT INTO pets VALUES (2, 'Basil', '2012-08-06', 6, 2);
INSERT INTO pets VALUES (3, 'Rosy', '2011-04-17', 2, 3);
INSERT INTO pets VALUES (4, 'Jewel', '2010-03-07', 2, 3);
INSERT INTO pets VALUES (5, 'Iggy', '2010-11-30', 3, 4);
INSERT INTO pets VALUES (6, 'George', '2010-01-20', 4, 5);
INSERT INTO pets VALUES (7, 'Samantha', '2012-09-04', 1, 6);
INSERT INTO pets VALUES (8, 'Max', '2012-09-04', 1, 6);
INSERT INTO pets VALUES (9, 'Lucky', '2011-08-06', 5, 7);
INSERT INTO pets VALUES (10, 'Mulligan', '2007-02-24', 2, 8);
INSERT INTO pets VALUES (11, 'Freddy', '2010-03-09', 5, 9);
INSERT INTO pets VALUES (12, 'Lucky', '2010-06-24', 2, 10);
INSERT INTO pets VALUES (13, 'Sly', '2012-06-08', 1, 10);

INSERT INTO visits VALUES (1, 7, '2013-01-01', 'rabies shot');
INSERT INTO visits VALUES (2, 8, '2013-01-02', 'rabies shot');
INSERT INTO visits VALUES (3, 8, '2013-01-03', 'neutered');
INSERT INTO visits VALUES (4, 7, '2013-01-04', 'spayed');

----

----
DROP TABLE vet_specialties IF EXISTS;
DROP TABLE vets IF EXISTS;
DROP TABLE specialties IF EXISTS;
DROP TABLE visits IF EXISTS;
DROP TABLE pets IF EXISTS;
DROP TABLE types IF EXISTS;
DROP TABLE owners IF EXISTS;


CREATE TABLE vets (
  id         INTEGER IDENTITY PRIMARY KEY,
  first_name VARCHAR(30),
  last_name  VARCHAR(30)
);
CREATE INDEX vets_last_name ON vets (last_name);

CREATE TABLE specialties (
  id   INTEGER IDENTITY PRIMARY KEY,
  name VARCHAR(80)
);
CREATE INDEX specialties_name ON specialties (name);

CREATE TABLE vet_specialties (
  vet_id       INTEGER NOT NULL,
  specialty_id INTEGER NOT NULL
);
ALTER TABLE vet_specialties ADD CONSTRAINT fk_vet_specialties_vets FOREIGN KEY (vet_id) REFERENCES vets (id);
ALTER TABLE vet_specialties ADD CONSTRAINT fk_vet_specialties_specialties FOREIGN KEY (specialty_id) REFERENCES specialties (id);

CREATE TABLE types (
  id   INTEGER IDENTITY PRIMARY KEY,
  name VARCHAR(80)
);
CREATE INDEX types_name ON types (name);

CREATE TABLE owners (
  id         INTEGER IDENTITY PRIMARY KEY,
  first_name VARCHAR(30),
  last_name  VARCHAR(30),
  address    VARCHAR(255),
  city       VARCHAR(80),
  telephone  VARCHAR(20)
);
CREATE INDEX owners_last_name ON owners (last_name);

CREATE TABLE pets (
  id         INTEGER IDENTITY PRIMARY KEY,
  name       VARCHAR(30),
  birth_date DATE,
  type_id    INTEGER NOT NULL,
  owner_id   INTEGER NOT NULL
);
ALTER TABLE pets ADD CONSTRAINT fk_pets_owners FOREIGN KEY (owner_id) REFERENCES owners (id);
ALTER TABLE pets ADD CONSTRAINT fk_pets_types FOREIGN KEY (type_id) REFERENCES types (id);
CREATE INDEX pets_name ON pets (name);

CREATE TABLE visits (
  id          INTEGER IDENTITY PRIMARY KEY,
  pet_id      INTEGER NOT NULL,
  visit_date  DATE,
  description VARCHAR(255)
);
ALTER TABLE visits ADD CONSTRAINT fk_visits_pets FOREIGN KEY (pet_id) REFERENCES pets (id);
CREATE INDEX visits_pet_id ON visits (pet_id);

----

** Console 

----
INFO 2016-09-06 11:56:11.981 [restartedMain] [appId] org.springframework.jdbc.datasource.init.ScriptUtils:444 - Executing SQL script from URL [file:/home/przodownik/blog/bootPetclinicCamp/target/classes/data-h2.sql]
INFO 2016-09-06 11:56:11.990 [restartedMain] [appId] org.springframework.jdbc.datasource.init.ScriptUtils:510 - Executed SQL script from URL [file:/home/przodownik/blog/bootPetclinicCamp/target/classes/data-h2.sql] in 9 ms.
----

** aplication.properties

----
spring.jpa.hibernate.ddl-auto=update
spring.datasource.schema=h2
spring.jpa.show-sql=true
spring.datasource.continue-on-error=true
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.sql-script-encoding=UTF-8
spring.datasource.username=sa
spring.datasource.password=
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.initialize=true
spring.datasource.platform=h2
----


===DEVTools
----
spring.devtools.restart.exclude=static/**,public/**
spring.devtools.restart.exclude=static/**,public/**,/templates/**
spring.devtools.restart.exclude=**/*Test.class,git.properties
spring.devtools.restart.additional-exclude = *.conf, *.properties


spring.resources.static-locations=classpath:/static/,file:../client/src/
spring.devtools.restart.additional-paths=../client/src/
spring.devtools.restart.additional-exclude=**/*.js,**/*.css


spring.devtools.restart.poll-interval=500
spring.devtools.restart.quiet-period=1
spring.devtools.restart.enabled=true
spring.devtools.restart.additional-paths=src/main/resources/
spring.devtools.restart.additional-exclude=**/*.js,**/*.css,**/*.html, **/*.svg, **/*.png, **/*.jpg, **/*.jpeg, **/*.ts
----


=== Save owner jpaData problem

----
There was an unexpected error (type=Bad Request, status=400).
Failed to convert value of type [java.lang.String] to required type [int]; nested exception is java.lang.NumberFormatException: For input string: "null"
----
 

----
Owner save(Owner owner) throws DataAccessException;
repo
service
controller

modify save method
----


=== PET save problem

----
Failed to convert property value of type [java.lang.String] to required type [java.time.LocalDateTime] for property 'birthDate'; nested exception is org.springframework.core.convert.ConversionFailedException: Failed to convert from type [java.lang.String] to type [@javax.persistence.Column @org.springframework.format.annotation.DateTimeFormat java.time.LocalDateTime] for value '2016/09/07'; nested exception is java.time.format.DateTimeParseException: Text '2016/09/07' could not be parsed: Unable to obtain LocalDateTime from TemporalAccessor: {},ISO resolved to 2016-09-07 of type java.time.format.Parsed
----

----
@Slf4j
public class LocalDateFormatter implements Formatter<LocalDate> {
    private DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy/MM/dd");
    @Override
    public LocalDate parse(String s, Locale locale) throws ParseException {
        log.info("LocalDateFormatter : parse : {}",s);
        LocalDate date = LocalDate.from(formatter.parse(s));
        return date;
    }
    @Override
    public String print(LocalDate localDate, Locale locale) {
        log.info("print : localDate : {}",localDate);
        return formatter.format(localDate);
    }
}
----

=== Thymeleaf problem

----
There was an unexpected error (type=Internal Server Error, status=500).
Exception evaluating SpringEL expression: "#dates.format(pet.birthDate.toDate(), 'yyyy-MM-dd')" (owners/ownerDetails:83)
----


----
<dependency>
    <groupId>org.thymeleaf.extras</groupId>
    <artifactId>thymeleaf-extras-java8time</artifactId>
    <version>2.1.0.RELEASE</version>
</dependency>
----

** Config

----
 @Bean
    public Java8TimeDialect java8TimeDialect() {
        return new Java8TimeDialect();
    }
----

** Thymeleaf


----
!-- <dd th:text="${#dates.format(pet.birthDate.toDate(), 'yyyy-MM-dd')}">[birthdate yyyy-MM-dd]</dd> -->
<dd th:text="${#temporals.format(pet.birthDate, 'dd/MM/yyyy')}">[birthdate yyyy-MM-dd]</dd>
----


** Visit

----
 <!-- <td th:text="${#dates.format(visit.date.toDate(), 'yyyy-MM-dd')}">[date yyyy-MM-dd</td> -->
 <td th:text="${#temporals.format(visit.date, 'dd/MM/yyyy')}">[date yyyy-MM-dd</td>
----

=== ContentNegotiation problem with xml and atom 

----
@Override
    public void configureContentNegotiation(ContentNegotiationConfigurer configurer) {
        HashMap<String, MediaType> mediaTypes = new HashMap<>();              
        mediaTypes.put("xml", MediaType.APPLICATION_XML); 
        mediaTypes.put("json", MediaType.APPLICATION_JSON);
        mediaTypes.put("atom", MediaType.APPLICATION_ATOM_XML);
        configurer.mediaTypes(mediaTypes).defaultContentType(MediaType.TEXT_HTML).favorParameter(false).favorPathExtension(true); 
        super.configureContentNegotiation(configurer); 
      }
    
/*    .parameterName("type")
    .favorParameter(true)
    .ignoreUnknownPathExtensions(false)
    .ignoreAcceptHeader(false)
*/
    
    @Autowired
    private ThymeleafViewResolver thymeleafResolver;
    
    @Override
    public void configureViewResolvers(ViewResolverRegistry registry) {
        registry.viewResolver(this.thymeleafResolver);
        registry.enableContentNegotiation(
                new MappingJackson2XmlView(),
                new MappingJackson2JsonView(),
                new VetsAtomView()
                );
    }
    
----
    

=== Lombok

=== Cache

Dependency

----
<dependency>
            <groupId>net.sf.ehcache</groupId>
            <artifactId>ehcache</artifactId>
            <version>2.10.2.2.21</version>
        </dependency>
----
        
                                 
Config

----
@EnableCaching
@Configuration
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager(EhCacheManagerFactoryBean factory) {
        return new EhCacheCacheManager(factory.getObject());
}
    
    @Bean
    public EhCacheManagerFactoryBean ehCacheManagerFactoryBean() {
        EhCacheManagerFactoryBean factory = new EhCacheManagerFactoryBean();
        factory.setCacheManagerName("EHCACHE");
        factory.setConfigLocation(new ClassPathResource("ehcache.xml"));        
        return factory;
}
}

----
    

** Guava

spring.cache.cache-names=foo,bar
spring.cache.guava.spec=maximumSize=500,expireAfterAccess=600s


** Coffeine

spring.cache.cache-names=foo,bar
spring.cache.caffeine.spec=maximumSize=500,expireAfterAccess=600s                              


** JCache

spring.cache.jcache.config=classpath:acme.xml                                 